<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>My Weather App</title>
    <style>
      /* ... (keep existing styles from previous dropdown example) ... */
      body {
        font-family: 'Segoe UI', system-ui, sans-serif;
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        color: #2d3748;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        max-width: 600px;
        margin: 20px;
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        transition: transform 0.2s ease;
      }

      .container:hover {
        transform: translateY(-5px);
      }

      h1 {
        text-align: center;
        color: #2d3748;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        text-align: center; /* Center the dropdown */
      }

      /* --- Style the select dropdown --- */
      select {
        width: 250px; /* Adjust width as needed */
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
        cursor: pointer;
        background-color: white;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px 12px;
      }
      select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .weather-container {
        text-align: center;
        margin-top: 1.5rem;
      }
      #weatherIcon {
        width: 100px;
        height: 100px;
        margin-top: 10px;
      }
      .error {
        color: red;
        margin-top: 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>

    <div class="container">
      <h1>My Weather App</h1>

      <div class="form-group">
        <!-- Replace input and button with a select dropdown -->
        <label for="citySelect" style="display: none;">Select City:</label>
        <select id="citySelect">
          <option value="">-- Select a City --</option>
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>

      <div class="weather-container">
        <h3 id="weatherTitle"></h3>
        <img id="weatherIcon" src="" alt="" style="display: none;"/>
        <p id="weatherDescription"></p>
        <p id="temperature"></p>
        <p id="feelsLike"></p>
        <p id="windSpeed"></p>
        <p id="errorMessage" class="error"></p>
      </div>
    </div>

    <script>
      // Get references to DOM elements
      const citySelect = document.getElementById('citySelect'); // Use the select element
      const weatherTitle = document.getElementById('weatherTitle');
      const weatherIcon = document.getElementById('weatherIcon');
      const weatherDescription = document.getElementById('weatherDescription');
      const temperature = document.getElementById('temperature');
      const feelsLike = document.getElementById('feelsLike');
      const windSpeed = document.getElementById('windSpeed');
      const errorMessage = document.getElementById('errorMessage');

      // Function to clear weather display
      function clearWeatherData() {
        weatherTitle.textContent = "";
        weatherIcon.src = "";
        weatherIcon.alt = "";
        weatherIcon.style.display = "none";
        weatherDescription.textContent = "";
        temperature.textContent = "";
        feelsLike.textContent = "";
        windSpeed.textContent = "";
        errorMessage.textContent = "";
      }

      // Function to fetch and display weather
      async function fetchAndDisplayWeather(city) {
        clearWeatherData();

        if (!city) { // Don't fetch if "-- Select a City --" is chosen
          return;
        }

        console.log(`Fetching weather for selected city: ${city}`);

        try {
          const response = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || `Error ${response.status}: Failed to fetch weather`);
          }

          weatherTitle.textContent = `Weather in ${data.name}`;
          weatherDescription.textContent = `Condition: ${data.description}`;
          temperature.textContent = `Temperature: ${data.temp !== undefined ? data.temp + ' °F' : 'N/A'}`;
          feelsLike.textContent = `Feels like: ${data.feels_like !== undefined ? data.feels_like + ' °F' : 'N/A'}`;
          windSpeed.textContent = `Wind speed: ${data.wind_speed !== undefined ? data.wind_speed + ' mph' : 'N/A'}`;

          if (data.icon) {
            weatherIcon.src = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
            weatherIcon.alt = data.description || "Weather Icon";
            weatherIcon.style.display = "inline-block";
          } else {
             weatherIcon.style.display = "none";
          }
        } catch (error) {
          console.error("Error fetching or displaying weather:", error);
          errorMessage.textContent = error.message || "Could not fetch weather data.";
          clearWeatherData();
          weatherTitle.textContent = `Could not load weather for ${city}`;
        }
      }

      // Function to populate the city dropdown
      async function populateCityDropdown() {
        try {
          // Fetch the list from the server's new endpoint
          const response = await fetch('/api/cities');
          if (!response.ok) {
            throw new Error(`Could not fetch city list (${response.status})`);
          }
          const cities = await response.json();

          // Clear any existing options except the placeholder
          citySelect.innerHTML = '<option value="">-- Select a City --</option>';

          cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
          });

        } catch (error) {
          console.error("Error populating cities:", error);
          errorMessage.textContent = "Could not load city list from server.";
          // Optionally disable the dropdown
          // citySelect.disabled = true;
        }
      }

      // Event Listener for Dropdown Change
      citySelect.addEventListener('change', (event) => {
        const selectedCity = event.target.value;
        fetchAndDisplayWeather(selectedCity); // Fetch weather for the selected city
      });

      // Initial setup when the page loads
      document.addEventListener('DOMContentLoaded', () => {
          populateCityDropdown(); // Fetch cities from server and populate dropdown
          clearWeatherData();     // Ensure weather display is initially empty
      });

    </script>

  </body>
</html>
